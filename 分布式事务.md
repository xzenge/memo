# 分布式事务

## 两阶段提交/XA

常见于单系统操作多数据源。
由于依赖数据库的事务，导致效率低，不适合高并发场景。

### 事务管理器

### 流程

- 第一阶段

	- 发起事务
	- 取消事务

- 第二阶段

	- 通知执行每一个任务

## TCC

适合对分布式一致性要求要的系统，如支付、交易等

### 流程

- Try

  对各个服务的资源进行检查，业务校验等。

- Confirm

  进行实际的操作

- Cancel

  错误发生时，对之前的操作进行回滚

### 问题

业务耦合比较大，需要大量的业务代码支持

## 本地消息表

可以保证事务的最终一致性，但不适用于高并发场景

### 流程

- A系统业务操作后落消息表并MQ通知B系统
- B系统接收消息后执行业务操作，并更新A、B信息消息状态
- B系统未成功时，A系统会一直重试到成功

## 可靠消息最终一致性

依赖RMQ的消息事务，和高可用，保证消息一定通知到，并最终保证事务的一致性

### 流程

- A系统发送prepare消息至MQ，并处理业务
- A系统处理业务成功后发送Confirm消息至MQ
- B系统收到Confirm消息后执行业务

## 最大努力通知方案

可以允许一定程度上的事务失败，一般用在对分布式事务不要个的系统，比如日志收集等

### A系统发送消息至MQ

### 最大努力系统接收MQ通知并调用B系统

*XMind: ZEN - Trial Version*